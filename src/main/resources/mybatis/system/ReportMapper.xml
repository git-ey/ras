<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ReportMapper">
	
	<!--表名 -->
	<sql id="tableName">
		SYS_REPORT
	</sql>
	
	<!-- 字段 -->
	<sql id="Field">
		RUN_PARAM,
		P1,
		P2,
		P3,
		P4,
		P5,
		OPERATOR,
		RUN_DATETIME,
		OUTBOND_PATH,
		RESULT,
		MESSAGE,
		REPORT_ID
	</sql>
	
	<!-- 字段值 -->
	<sql id="FieldValue">
		#{RUN_PARAM},
		#{P1},
		#{P2},
		#{P3},
		#{P4},
		#{P5},
		#{OPERATOR},
		#{RUN_DATETIME},
		#{OUTBOND_PATH},
		#{RESULT},
		#{MESSAGE},
		#{REPORT_ID}
	</sql>
	
	<!-- 新增-->
	<insert id="save" parameterType="pd">
		insert into 
	<include refid="tableName"></include>
		(
	<include refid="Field"></include>
		) values (
	<include refid="FieldValue"></include>
		)
	</insert>
	
	<!-- 删除-->
	<delete id="delete" parameterType="pd">
		delete from
		<include refid="tableName"></include>
		where 
			REPORT_ID = #{REPORT_ID}
	</delete>
	
	<!-- 修改 -->
	<update id="edit" parameterType="pd">
		update
		<include refid="tableName"></include>
		set RESULT = #{RESULT},
			MESSAGE = #{MESSAGE}
		where REPORT_ID = #{REPORT_ID}
	</update>
	
	<!-- 通过ID获取数据 -->
	<select id="findById" parameterType="pd" resultType="pd">
		select 
		<include refid="Field"></include>
		from 
		<include refid="tableName"></include>
		where 
			REPORT_ID = #{REPORT_ID}
	</select>
	
	<!-- 列表 -->
	<select id="datalistPage" parameterType="page" resultType="pd">
		select
		  CONCAT(RUN_PARAM,',',P1,',',P2,',',P3,',',P4,',',P5) REPORT_PARAM,
		  OPERATOR,
		  RUN_DATETIME,
		  OUTBOND_PATH,
		  RESULT,
		  MESSAGE,
		  REPORT_ID
		from 
		<include refid="tableName"></include>
		where 1=1
		<if test="pd.keywords!= null and pd.keywords != ''"><!-- 关键词检索 -->
			and
				(
				<!-- 根据需求自己加检索条件 -->
					RUN_PARAM LIKE CONCAT(CONCAT('%', #{pd.keywords}),'%')
					 or 
					OUTBOND_PATH LIKE CONCAT(CONCAT('%', #{pd.keywords}),'%') 
				)
		</if>
		<if test="pd.lastStart!= null and pd.lastStart != ''">
		    and RUN_DATETIME &gt;= #{pd.lastStart}
		</if>
		<if test="pd.lastEnd!= null and pd.lastEnd != ''">
		    and RUN_DATETIME &lt;= #{pd.lastEnd}
		</if>
		<if test="pd.RESULT != null and pd.RESULT != ''">
		    and RESULT = #{pd.RESULT}
		</if>
		order by RUN_DATETIME desc
	</select>
	
	<!-- 列表(全部) -->
	<select id="listAll" parameterType="pd" resultType="pd">
		select
		<include refid="Field"></include>
		from 
		<include refid="tableName"></include>
	</select>
	
	<!-- 批量删除 -->
	<delete id="deleteAll" parameterType="String">
		delete from
		<include refid="tableName"></include>
		where 
			REPORT_ID in
		<foreach item="item" index="index" collection="array" open="(" separator="," close=")">
                 #{item}
		</foreach>
	</delete>
	
	<!-- 列表报告段落模板 -->
	<select id="listParagraph" parameterType="String" resultType="pd">
        select d.BIANMA PARAGRAPH,
               d.`NAME` PARAGRAPH_NAME,
               d.NAME_EN PARAGRAPH_PATH
          from sys_dictionaries d 
         where d.PARENT_ID in (select sd.DICTIONARIES_ID 
                                 from sys_dictionaries sd 
                                where sd.BIANMA = #{paragraphCode})
         order by d.ORDER_BY asc
	</select>
	
	<!-- 列表报告段落模板 -->
	<select id="listParagraphAll" parameterType="pd" resultType="pd">
	   SELECT sd.BIANMA PARAGRAPH_TYPE,
               d.BIANMA PARAGRAPH_CODE,
               d.`NAME` PARAGRAPH_NAME,
               d.NAME_EN PARAGRAPH_PATH
          FROM sys_dictionaries d,
               sys_dictionaries sd
         WHERE d.PARENT_ID = sd.DICTIONARIES_ID 
           AND sd.BIANMA IN ('RP01','RP02','RP03','RP04','RP05')
         ORDER BY sd.BIANMA,d.ORDER_BY ASC
	</select>
	
	<!-- 报告导出基金范围列表 -->
	<select id="listReportFund" parameterType="pd" resultType="pd">
		select sf.FUND_CODE,	
		       sf.FIRM_CODE,	
		       sf.SHORT_NAME,	
		       sf.FULL_NAME,	
		       sf.FULL_NAME_ORIGINAL,	
		       sf.TA_NAME,
		       sf.MF,
		       sf.ETF,
		       sf.STRUCTURED,
		       sf.DATE_FROM,	
		       sf.DATE_TO,	
		       sf.DATE_TRANSFORM
		from sys_fund_info sf
		where sf.FIRM_CODE = #{FIRM_CODE}
		<if test="FUND_ID != null and FUND_ID != ''">
		    and sf.FUND_ID = #{FUND_ID}
		</if>
		<if test="MF != null and MF != ''">
		    and sf.MF = #{MF}
		</if>
		<if test="ETF != null and ETF != ''">
		    and sf.ETF = #{ETF}
		</if>
		<if test="STRUCTURED != null and STRUCTURED != ''">
		    and sf.STRUCTURED = #{STRUCTURED}
		</if>
	</select>
	
</mapper>